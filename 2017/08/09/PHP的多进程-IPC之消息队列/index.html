<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>PHP的多进程--IPC之消息队列 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言PHP 的多进程系列，记录我对 PHP 多进程的学习和理解。这里写的内容可能会有错误，希望各位发现后不吝指正，谢谢。 我的邮箱是: tjutwei@163.com，欢迎各位来信讨论相关问题。">
<meta name="keywords" content="PHP,进程通信,消息队列">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP的多进程--IPC之消息队列">
<meta property="og:url" content="http://yoursite.com/2017/08/09/PHP的多进程-IPC之消息队列/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="前言PHP 的多进程系列，记录我对 PHP 多进程的学习和理解。这里写的内容可能会有错误，希望各位发现后不吝指正，谢谢。 我的邮箱是: tjutwei@163.com，欢迎各位来信讨论相关问题。">
<meta property="og:updated_time" content="2017-08-12T07:35:39.198Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PHP的多进程--IPC之消息队列">
<meta name="twitter:description" content="前言PHP 的多进程系列，记录我对 PHP 多进程的学习和理解。这里写的内容可能会有错误，希望各位发现后不吝指正，谢谢。 我的邮箱是: tjutwei@163.com，欢迎各位来信讨论相关问题。">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-PHP的多进程-IPC之消息队列" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/09/PHP的多进程-IPC之消息队列/" class="article-date">
  <time datetime="2017-08-09T06:21:14.000Z" itemprop="datePublished">2017-08-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/基础知识/">基础知识</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      PHP的多进程--IPC之消息队列
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>PHP 的多进程系列，记录我对 PHP 多进程的学习和理解。这里写的内容可能会有错误，希望各位发现后不吝指正，谢谢。</p>
<p>我的邮箱是: <a href="mailto:tjutwei@163.com" target="_blank" rel="noopener">tjutwei@163.com</a>，欢迎各位来信讨论相关问题。</p>
<a id="more"></a>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p><a href="">PHP的多进程–基础介绍</a></p>
<p><a href="">PHP的多进程–防止僵尸进程</a></p>
<p><a href="">PHP的多进程–共享数据</a></p>
<p><a href="">PHP的多进程–IPC之共享内存</a></p>
<p><a href="">PHP的多进程–IPC之信号量</a></p>
<p><a href="">PHP的多进程–IPC之消息队列</a></p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>PHP 实现进程通信（IPC：InterProcess Communication）的方式有以下几种：共享内存、信号量、消息队列、信号、管道和 socket。</p>
<p>这篇的内容是 PHP 通过<strong>消息队列</strong>实现进程通信。使用消息队列需要 PHP 安装 sysvmsg 扩展（在 congfigure 时使用 <code>--enable-sysvmsg</code> 配置）。</p>
<h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><p>消息队列是一个和 Linux 内核相关联的数据结构，本质上是一个消息的链表。通过消息队列的好处是：发送方不必等待接收方检查它所收到的消息就可以继续工作下去，而接收方如果没有收到消息也不需等待。这种通信机制相对简单。</p>
<p>由于消息队列每次只有一个进程能取到消息，所以不需要额外的锁或信号量。</p>
<h3 id="相关函数"><a href="#相关函数" class="headerlink" title="相关函数"></a>相关函数</h3><pre><code>&lt;?php

//生成一个消息队列的key
$msg_key = ftok(__FILE__, &apos;a&apos;);

//产生一个消息队列，第二个参数为权限
$msg_queue = msg_get_queue($msg_key, 0666);

//检测一个队列是否存在 ,返回boolean值
$status = msg_queue_exists($msg_key);

//可以查看当前队列的一些详细信息
$status =  msg_stat_queue($msg_queue);

//将一条消息加入消息队列
msg_send($msg_queue, 1, &quot;Hello World&quot;);

//从消息队列中读取一条消息，放在data里面
msg_receive($msg_queue, 1, $message_type, 1024, $data);

//移除消息队列
msg_remove_queue($msg_queue);
</code></pre><h3 id="实例1"><a href="#实例1" class="headerlink" title="实例1"></a>实例1</h3><p>创建5个子进程向消息队列添加消息，父进程在回收子进程之后从消息队列里取。</p>
<pre><code>&lt;?php
// 创建消息队列 
$message_queue_key = ftok(__FILE__, &apos;a&apos;);
$message_queue = msg_get_queue($message_queue_key, 0666);

$pids = array();
for ($i = 0;  $i &lt; 5; $i++) {
        // 创建子进程
        $pids[$i] = pcntl_fork();

        if ($pids[$i]) {
                echo &quot;No.$i child process was created, the pid is $pids[$i]\r\n&quot;;
                // 防止僵尸进程的出现
                pcntl_wait($status);   // 阻塞
                // pcntl_wait($status, WNOHANG);  // 非阻塞
        } elseif ($pids[$i] == 0) {
                $pid = posix_getpid();
                echo &quot;process.$pid is writing now\r\n&quot;;
                // 向消息队列里添加消息     
                msg_send($message_queue, 1, &quot;this is process.$pid&apos;s data\r\n&quot;);
                // 向子进程发送SINTERM信号，结束子进程
                posix_kill($pid, SIGTERM);
        }
}

do {
    // 从消息队列中取出消息
    msg_receive($message_queue, 0, $message_type, 1024, $message, true, MSG_IPC_NOWAIT); 
    echo $message;
    // 消息队列中的消息为0，跳出死循环
    $a = msg_stat_queue($message_queue);
    if($a[&apos;msg_qnum&apos;] == 0){
        break;
    }
} while(true)
?&gt;
</code></pre><p>执行结果：</p>
<pre><code>No.0 child process was created, the pid is 2196
process.2196 is writing now
No.1 child process was created, the pid is 2197
process.2197 is writing now
No.2 child process was created, the pid is 2198
process.2198 is writing now
No.3 child process was created, the pid is 2199
process.2199 is writing now
No.4 child process was created, the pid is 2200
process.2200 is writing now
this is process.2196&apos;s data
this is process.2197&apos;s data
this is process.2198&apos;s data
this is process.2199&apos;s data
this is process.2200&apos;s data
</code></pre><p>可以看到子进程写入的消息被父进程取了出来，并且是按照 FIFO 的顺序。</p>
<h3 id="实例2"><a href="#实例2" class="headerlink" title="实例2"></a>实例2</h3><p>下面这段代码模拟了一个日常的任务。</p>
<p>父进程 A 产生任务（将大量数据放到消息队列中），然后创建一个子进程 B，将任务交给 B 处理。B 发现任务量很大，所以创建了另外 10 个子进程来进行处理（从消息队列中取数据）。</p>
<pre><code>&lt;?php
// 设定脚本永不超时
set_time_limit(0);
// 创建消息队列
$ftok = ftok(__FILE__, &apos;a&apos;);
$msg_queue = msg_get_queue($ftok);
$pidarr = [];

// A产生子进程B
$pid = pcntl_fork();
if ($pid) {
    // 父进程A模拟生成一个特大的数组。
    $arr = range(1,100000);

    // 将任务放进队里
    foreach ($arr as $val) {
        $status = msg_send($msg_queue,1, $val);
        // 和sleep()函数类似，暂停进程执行，以毫秒为单位
        usleep(1000);
    }
    $pidarr[] = $pid;
    // 有疑问，原博主没有注释，个人认为应该放在后面，等任务全部执行完再销毁
    //msg_remove_queue($msg_queue);
} else {
    //子进程收到任务后，fork10个子进程来处理任务。
    for ($i =0; $i&lt;10; $i++) {
        $childpid = pcntl_fork();
        if ($childpid) {
            $pidarr[] = $childpid; //收集子进程processid
        } else {
            while (true) {
                msg_receive($msg_queue, 0, $msg_type, 1024, $message);
                // 消息队列为空时结束子进程
                if (!$message) exit(0);
                echo $message.PHP_EOL;
                usleep(1000);
            }
        }
    }
}

// 防止主进程先于子进程退出，形成僵尸进程
while (count($pidarr) &gt; 0) {
    foreach ($pidarr as $key =&gt; $pid) {
        $status = pcntl_waitpid($pid, $status);
        if ($status == -1 || $status &gt; 0) {
            unset($pidarr[$key]);
        }
    }
    sleep(1);
}
?&gt;
</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.douban.com/note/245520545/" target="_blank" rel="noopener">PHP实现进程间通信:消息队列</a></p>
<p><a href="http://www.cnblogs.com/roverliang/p/6226980.html" target="_blank" rel="noopener">PHP 进程间通信——消息队列(msg_queue)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/08/09/PHP的多进程-IPC之消息队列/" data-id="cjee8rhp7004e4svn184xapz7" class="article-share-link">Teilen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/消息队列/">消息队列</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/进程通信/">进程通信</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/08/11/PHP的多进程-IPC之信号/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          PHP的多进程--IPC之信号
        
      </div>
    </a>
  
  
    <a href="/2017/08/09/PHP的多进程-IPC之信号量/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">PHP的多进程--IPC之信号量</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorien</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/PHP内核/">PHP内核</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/基础教程/">基础教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/基础知识/">基础知识</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习笔记/">学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/教程/">教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活杂记/">生活杂记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/科研/">科研</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程基础/">编程基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/课程/">课程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/面试/">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apache/">Apache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CMD/">CMD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Excel/">Excel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FastCGI/">FastCGI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/">Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Matlab/">Matlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenCV/">OpenCV</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP求职宝典/">PHP求职宝典</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/R/">R</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RStudio/">RStudio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEO/">SEO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/">TCP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ThinkPHP/">ThinkPHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/echo/">echo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pcntl/">pcntl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rewrite/">rewrite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sem/">sem</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shmop/">shmop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket/">socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/信号/">信号</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/信号量/">信号量</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/垃圾回收/">垃圾回收</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/字符编码/">字符编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/径向基/">径向基</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/排序算法/">排序算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/正则/">正则</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息队列/">消息队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫/">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/生活/">生活</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/神经网络/">神经网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/管道/">管道</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/缓存/">缓存</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/计算机网络/">计算机网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/进程/">进程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/进程通信/">进程通信</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/进程，线程/">进程，线程</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Apache/" style="font-size: 14.44px;">Apache</a> <a href="/tags/CMD/" style="font-size: 10px;">CMD</a> <a href="/tags/Excel/" style="font-size: 10px;">Excel</a> <a href="/tags/FastCGI/" style="font-size: 10px;">FastCGI</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Linux/" style="font-size: 12.22px;">Linux</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/Matlab/" style="font-size: 18.89px;">Matlab</a> <a href="/tags/MySQL/" style="font-size: 16.67px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 14.44px;">Nginx</a> <a href="/tags/OpenCV/" style="font-size: 11.11px;">OpenCV</a> <a href="/tags/PHP/" style="font-size: 20px;">PHP</a> <a href="/tags/PHP求职宝典/" style="font-size: 11.11px;">PHP求职宝典</a> <a href="/tags/R/" style="font-size: 10px;">R</a> <a href="/tags/RStudio/" style="font-size: 10px;">RStudio</a> <a href="/tags/SEO/" style="font-size: 10px;">SEO</a> <a href="/tags/TCP/" style="font-size: 12.22px;">TCP</a> <a href="/tags/ThinkPHP/" style="font-size: 10px;">ThinkPHP</a> <a href="/tags/echo/" style="font-size: 10px;">echo</a> <a href="/tags/pcntl/" style="font-size: 12.22px;">pcntl</a> <a href="/tags/rewrite/" style="font-size: 12.22px;">rewrite</a> <a href="/tags/sem/" style="font-size: 10px;">sem</a> <a href="/tags/shmop/" style="font-size: 10px;">shmop</a> <a href="/tags/socket/" style="font-size: 10px;">socket</a> <a href="/tags/信号/" style="font-size: 10px;">信号</a> <a href="/tags/信号量/" style="font-size: 10px;">信号量</a> <a href="/tags/垃圾回收/" style="font-size: 10px;">垃圾回收</a> <a href="/tags/字符编码/" style="font-size: 12.22px;">字符编码</a> <a href="/tags/径向基/" style="font-size: 11.11px;">径向基</a> <a href="/tags/排序算法/" style="font-size: 15.56px;">排序算法</a> <a href="/tags/正则/" style="font-size: 11.11px;">正则</a> <a href="/tags/消息队列/" style="font-size: 10px;">消息队列</a> <a href="/tags/爬虫/" style="font-size: 10px;">爬虫</a> <a href="/tags/生活/" style="font-size: 10px;">生活</a> <a href="/tags/神经网络/" style="font-size: 17.78px;">神经网络</a> <a href="/tags/算法/" style="font-size: 14.44px;">算法</a> <a href="/tags/管道/" style="font-size: 10px;">管道</a> <a href="/tags/缓存/" style="font-size: 13.33px;">缓存</a> <a href="/tags/计算机网络/" style="font-size: 13.33px;">计算机网络</a> <a href="/tags/设计模式/" style="font-size: 14.44px;">设计模式</a> <a href="/tags/进程/" style="font-size: 12.22px;">进程</a> <a href="/tags/进程通信/" style="font-size: 14.44px;">进程通信</a> <a href="/tags/进程，线程/" style="font-size: 10px;">进程，线程</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/03/04/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2018/01/01/查看系统位数、版本号和内核版本号/">查看系统位数、版本号和内核版本号</a>
          </li>
        
          <li>
            <a href="/2017/10/10/电脑开机时发生了什么？/">电脑开机时发生了什么？</a>
          </li>
        
          <li>
            <a href="/2017/10/01/PHP安全处理字符串/">PHP安全处理字符串</a>
          </li>
        
          <li>
            <a href="/2017/09/28/PHP爬取百度图片/">PHP爬取百度图片</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>